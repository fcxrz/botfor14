import asyncio
import os
import logging
from dotenv import load_dotenv
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.fsm.storage.memory import MemoryStorage
from apscheduler.schedulers.asyncio import AsyncIOScheduler

#—Å —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–∫–∏–¥
from handlers import admin, scheduler, menu
from db.sqlite import Database
from ai_engine.model import AIEngine
from pywe_storage import MemoryStorage
from handlers import scheduler as paschalka_scheduler  # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª–∏ —Ñ–∞–π–ª –≤ –∫–æ–¥–µ
from apscheduler.schedulers.asyncio import AsyncIOScheduler

load_dotenv()

# –≤ —Ä–∞–∏–ª–≤–µ–µ –¥–æ–±–∞–≤—å—Ç–µ TELEGRAM_BOT_TOKEN –≤ variables
TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
SERYOZHA_ID = int(os.getenv("SERYOZHA_ID", 0)) # –≤–∞—à –∞–π–¥–∏—à–Ω–∏–∫
ANGEL_ID = int(os.getenv("ANGEL_ID", 0)) # –∞–π–¥–∏—à–Ω–∏–∫ –ª—é–±–∏–º–æ–π

aioproc = AsyncIOScheduler()

async def main():
    #–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –µ–ø—Ç–∞
    logging.basicConfig(level=logging.WARNING)

    storage = MemoryStorage()
    bot = Bot(token=TOKEN)
    dp = Dispatcher()
    db = Database()
    ai = AIEngine()

    # –ø—Ä–æ–±—Ä–æ—Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ —Ö–µ–Ω–¥–ª–µ—Ä—ã
    dp["db"] = db
    dp["ai"] = ai
    dp["seryozha_id"] = SERYOZHA_ID
    dp["angel_id"] = ANGEL_ID
    dp["scheduler"] = aioproc

    if admin.router:
        dp.include_router(admin.router) # –°–ù–ê–ß–ê–õ–ê –î–ñ–ï–ù–¢–ï–õ–¨–ú–ï–ù
    if menu.router:
        dp.include_router(menu.router) # –ü–û–¢–û–ú –î–ê–ú–ê

    aioproc.start()
    print("–ë–æ—Ç –≤ –ø–æ—Ä—è–¥–µ –≤—Å–µ –Ω–æ—Ä–º!")

    if hasattr(paschalka_scheduler, 'setup_scheduler'):
        paschalka_scheduler.setup_scheduler(
            bot, 
            db, 
            ANGEL_ID, 
            SERYOZHA_ID, 
            aioproc # –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
        )


    @dp.message(Command("start"))
    async def start(message: types.Message):
        if message.from_user.id == SERYOZHA_ID:
            db.set_user(message.from_user.id, "admin")
            await message.answer("–ü—Ä–∏–≤–µ—Ç, –°–µ—Ä—ë–∂–∞! –¢–≤–æ–∏ –∫–æ–º–∞–Ω–¥—ã: /–æ—Ç–∫–ª–∏–∫, /–ø–∞—Å—Ö–∞–ª–∫–∞, /–º–æ–º–µ–Ω—Ç—ã")
        else:
            db.set_user(message.from_user.id, "girl")
            await message.answer("–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–æ—Å—Ç –º–µ–∂–¥—É —Ç–æ–±–æ–π –∏ –°–µ—Ä–µ–∂–µ–π! \n\n"
                                 "–Ø - –≤–∞—à –ø–æ—Å—Ä–µ–¥–Ω–∏–∫, —è –ª–∏—à—å –ø–µ—Ä–µ–¥–∞—é —Å–∏–≥–Ω–∞–ª—ã –∏ –ø–æ–º–æ–≥–∞—é –≤–∞–º. –ú–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å–Ω–∏–∑—É: \n\n"
                                 "üò§ –î–∞—Ç—å –ø–∏–Ω–∫–∞ üò§ - –¥–∞—Å—Ç –°–µ—Ä–µ–∂–µ –ø–æ–Ω—è—Ç—å, —á—Ç–æ —Ç—ã –≥–æ—Ç–æ–≤–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥, –Ω–æ –µ–º—É –Ω—É–∂–Ω–æ —É—Å—Ç—É–ø–∏—Ç—å –∏ –Ω–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥.\n\n"
                                 "‚ú® –¢—ë–ø–ª—ã–π –∏–º–ø—É–ª—å—Å ‚ú® - —ç—Ç–∞ –∫–Ω–æ–ø–∫–∞ —Å–¥–µ–ª–∞–Ω–∞ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø—Ä–æ—Å—Ç–æ –¥–∞—Ç—å –°–µ—Ä–µ–∂–µ –ø–æ–Ω—è—Ç—å, —á—Ç–æ —Ç—ã —Ä—è–¥–æ–º. –ò–Ω–æ–≥–¥–∞ –æ–Ω —á—É–≤—Å—Ç–≤—É–µ—Ç, —á—Ç–æ –æ–Ω –æ–¥–∏–Ω. –ï–º—É –±—É–¥–µ—Ç –ø—Ä–∏—è—Ç–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —ç—Ç–æ—Ç –∏–º–ø—É–ª—å—Å.\n\n"
                                 "üß£ –ú—è–≥–∫–∏–π –º–æ—Å—Ç üß£ - –∫–Ω–æ–ø–∫–∞ –¥–ª—è —Ç–≤–æ–µ–≥–æ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —ç–º–æ—Ü–∏–µ–π. –¢—ã –≤—ã–±–∏—Ä–∞–µ—à—å —ç–º–æ—Ü–∏—é –∏ –ø–∏—à–µ—à—å —á—Ç–æ –∏ –ø–æ—á–µ–º—É —Ç—ã –µ–µ —Å–µ–π—á–∞—Å –∏—Å–ø—ã—Ç—ã–≤–∞–µ—à—å. –ü–æ—Ç–æ–º –≤—ã–±–∏—Ä–∞–µ—à—å –¥–∞—Ç—É, –∫–æ–≥–¥–∞ –°–µ—Ä–µ–∂–∞ —Å–º–æ–∂–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —ç—Ç—É '–∫–∞–ø—Å—É–ª—É'.\n\n"
                                 "ü§≠ –ò–≥—Ä–∏–≤—ã–π –≤—ã–∑–æ–≤ ü§≠ - –µ—Å–ª–∏ –≤—ã –Ω–µ –ø—Ä–∏–¥—É–º–∞–ª–∏ —á–µ–º –±—ã –≤–∞–º –∑–∞–Ω—è—Ç—å—Å—è, —Ç–æ —ç—Ç–æ—Ç –±–æ—Ç –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –≤–∞–º 1 –∏–¥–µ—é, –∫–∞–∫ –≤–º–µ—Å—Ç–µ —Å–∫–æ—Ä–æ—Ç–∞—Ç—å –≤–µ—á–µ—Ä. –ó–∞ –æ—Å–Ω–æ–≤—É –æ–Ω –±–µ—Ä–µ—Ç –≤—Ä–µ–º—è –∏ –ø–æ–≥–æ–¥—É –≤ –û–º—Å–∫–µ.\n\n"
                                 "üß∏ –≠—Ö–æ –±–ª–∏–∑–æ—Å—Ç–∏ üß∏ - –ø–æ—á—Ç–∏ —Ç–æ–∂–µ —Å–∞–º–æ–µ, —á—Ç–æ –∏ –º—è–≥–∫–∏–π –º–æ—Å—Ç, –ù–û! –ë–µ—Ä–µ—Ç —Ç–≤–æ–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ. –≠—Ç–æ —Ç—ã –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –ø–æ–¥–¥–µ—Ä–∂–∫—É, –∞ –Ω–µ –ø–µ—Ä–µ–¥–∞—á—É —Å–≤–æ–µ–π —ç–º–æ—Ü–∏–∏ –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç.\n\n"
                                 "üåå –ú–æ—Å—Ç –ø–æ–Ω–∏–º–∞–Ω–∏—è üåå - –æ—á–µ–Ω—å –ø—Ä–∞–∫—Ç–∏—á–Ω–∞—è –≤–µ—â—å! –ü—Ä–∏ —Å—Å–æ—Ä–∞—Ö –æ–Ω —Å–ª—É—à–∞–µ—Ç —Å–Ω–∞—á–∞–ª–∞ —Ç–≤–æ—é —Ç–æ—á–∫—É –∑—Ä–µ–Ω–∏—è, –ø–æ—Ç–æ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫ –°–µ—Ä–µ–∂–µ, —Å–ª—É—à–∞–µ—Ç –µ–≥–æ —Ç–æ—á–∫—É –∑—Ä–µ–Ω–∏—è –∏ –ø—Ä–∏–¥—É–º—ã–≤–∞–µ—Ç –∫–æ–º–ø—Ä–æ–º–∏—Å—Å.\n !–ü–û–ö–ê –ß–¢–û –ì–û–õ–û–°–û–í–´–ï –í –ù–ï–ú –ù–ï–î–û–°–¢–£–ü–ù–´! –ù–æ –°–µ—Ä–µ–∂–∞ —á—Ç–æ-–Ω–∏–±—É–¥—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–¥—É–º–∞–µ—Ç.\n\n"
                                 "üîî –Ø –≤ –ø–æ—Ä—è–¥–∫–µ üîî - –∫–Ω–æ–ø–∫–∞ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –æ–ø–æ–≤–µ—Å—Ç–∏—Ç—å –°–µ—Ä–µ–∂—É, —á—Ç–æ –≤—Å–µ –≤–ø–æ—Ä—è–¥–∫–µ. –ò–Ω–æ–≥–¥–∞ –°–µ—Ä–µ–∂–∞ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —á–µ—Ä–µ–∑ –º–µ–Ω—è —Ç–µ–±–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ–±—ã —Ç—ã –æ—Ç–∫–ª–∏–∫–Ω—É–ª–∞—Å—å."

                                 , reply_markup=menu.get_main_menu())
    
    await dp.start_polling(bot)

if not TOKEN:
    exit("–û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω Telegram –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.")

if __name__ == "__main__":
    asyncio.run(main())